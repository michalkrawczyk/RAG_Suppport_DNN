name: Dependency Check

on:
  push:
    branches: [main]
    paths:
      - dependencies/requirements.txt
      - dependencies/requirements_agents_base.txt
      - dependencies/requirements_agents_openai.txt
      - dependencies/requirements_agents_nvidia.txt
      - dependencies/requirements_agents_nvidia_mamba.txt
  pull_request:
    branches: [main]
    paths:
      - dependencies/requirements.txt
      - dependencies/requirements_agents_base.txt
      - dependencies/requirements_agents_openai.txt
      - dependencies/requirements_agents_nvidia.txt
      - dependencies/requirements_agents_nvidia_mamba.txt

jobs:
  dependency-check:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install mandatory dependencies (requirements.txt)
        run: |
          python -m pip install --upgrade pip
          if [ -f "dependencies/requirements.txt" ]; then
            # Install torch CPU version to avoid slow CUDA installation
            pip install 'torch>=2.3.0' --index-url https://download.pytorch.org/whl/cpu
            # Install remaining dependencies (torch will be skipped as already satisfied)
            pip install -r dependencies/requirements.txt
          else
            echo "Error: dependencies/requirements.txt not found."
            exit 1
          fi

      - name: Check for dependency issues (mandatory)
        run: pip check

      - name: Install optional dependencies (requirements_agents_base.txt)
        run: |
          if [ -f "dependencies/requirements_agents_base.txt" ]; then
            pip install -r dependencies/requirements_agents_base.txt
          else
            echo "Warning: dependencies/requirements_agents_base.txt not found. Skipping optional dependencies."
          fi
        continue-on-error: true

      - name: Check for dependency issues (optional agents)
        run: pip check
        continue-on-error: true

      - name: Show dependency tree (pipdeptree)
        run: |
          pip install pipdeptree
          pipdeptree
        continue-on-error: true
